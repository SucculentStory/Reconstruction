% Tutorial 3: Manipulating Data in R
% R Bootcamp HTML Slides
% Jared Knowles

# Overview
In this lesson we hope to learn:
- Aggregating data
- Organizing our data
- Manipulating vectors
- Dealing with missing data


```{r setup, include=FALSE}
# set global chunk options
opts_chunk$set(fig.path='figure/slides3-', cache.path='cache/slides3-',fig.width=8,fig.height=6,message=FALSE,error=FALSE,warning=FALSE,echo=TRUE)
```


# Again, read in our dataset
```{r readdata}
# Set working directory to the tutorial directory
# In RStudio can do this in "Tools" tab
setwd('~/GitHub/r_tutorial_ed')
#Load some data
df<-read.csv('data/smalldata.csv')
# Note if we don't assign data to 'df'
# R just prints contents of table
```

# Aggregation
- Sometimes we need to do some basic checking for the number of observations or types of observations in our dataset
- To do this quickly and easily--the `table` function is our friend
- Let's look at our observations by year and grade
```{r table}
table(df$grade,df$year)
```
- The first command gives the rows, the second gives the columns

# Aggregation can be more complex
- Let's aggregate by race and year

```{r table2}
table(df$year,df$race)
```

- Race is consistent across years, interesting
- What if we want to only look at 3rd graders that year?

# More complicated still

```{r table3}
with(df[df$grade==3,],{table(year,race)})
```
- `with` specifies a data object to work on, in this case all elements of `df` where `grade==3`
- `table` is the same command as above, but since we specified the data object in the `with` statement, we don't need the `df$` in front of the variables of interest

# Tables cont.
- This is really powerful for looking at the descriptive dimensions of the data, we can ask questions like:
- how many students are at each proficiency level each year?
```{r proftable}
table(df$year,df$proflvl)
```
- how many students are at each proficiency level by race?
```{r raceproftable}
table(df$race,df$proflvl)
```

# Proportional Tables
- What if we aren't interested in counts? 
- R makes it really easy to calculate proportions
```{r proptable1}
prop.table(table(df$race,df$proflvl))
```
- Hmmm, this is goofy. This tells us the proportion of each cell out of the total. Also, the digits are distracting. How can we fix this?
```{r proptable2}
round(prop.table(table(df$race,df$proflvl),1),digits=3)
```
- The `1` tells R we want proportions rowise, a `2` goes columnwise
- A few more problems arise--this pools all observations, including students across years

# Aggregating Data
- One of the most common questions will be to compute aggregates of data
- R has an `aggregate` function that can be used
- This works great for simple aggregation like scale score by race, we just need a `formula` (think I want variable X **by** grouping factor Y) and the statistic we want to compute

```{r aggregate1}
# Reading Scores by Race
aggregate(readSS~race,FUN=mean,data=df)
```

# Aggregate (II)
- `aggregate` can take us a little further, we can use aggregate multiple variables at a time
```{r aggregate2}
aggregate(cbind(readSS,mathSS)~race,data=df,mean)
```
- We can add multiple grouping varialbes using the `formula` syntax
```{r aggregate3}
head(aggregate(cbind(readSS,mathSS)~race+grade,data=df,mean),8)
```
- We can build a systematic cross-tab now
```{r crosstab}
ag<-aggregate(readSS~race+grade,data=df,mean)
xtabs(readSS~., data=ag)
```
- And prettier output
```{r crosstabpretty}
ftable(xtabs(readSS~.,data=ag))
```

# Aggregate Isn't Enough
- `aggregate` is cool, but it isn't very flexible
- We can only use aggregate output as a table, which we have to convert to a data frame
- There is a better way; the `plyr` package
- `plyr` is a set of routines/logical structure for transforming, summarizing, reshaping, and reorganizing data objects of one type in R into another type
- We will focus here on summarizing and aggregating a data frame, but later in the bootcamp we'll apply functions to lists and turn lists into data frames as well
- This is cool!

# School Means
- Consider the case we want to turn our student level data into school level data
- Who hasn't had to do this?!?
- In `aggregate` we do:
```{r aggregate4}
z<-aggregate(readSS~dist,FUN=mean,data=df)
z
```
- But I want more! I want to aggregate multiple variables. I want to do it across multiple groups. I want the output to be a dataframe I can work on.
- Thank you `plyr`

# Using plyr
- `plyr` has a straightforward syntax
- All `plyr` functions are in the format **XX**ply. The two X's specify what the input file we are applying a function to is, and then what way we would like it outputted.
- In `plyr` d = dataframe, l= list, m=matrix, and a=array. By far the most common usage is `ddply`
- From a dataframe, to a dataframe.

# plyr in Action
```{r plyr1}
library(plyr)
myag<-ddply(df, .(dist,grade),summarize,
            mean_read=mean(readSS,na.rm=T),
            mean_math=mean(mathSS,na.rm=T),
            sd_read=sd(readSS,na.rm=T),
            sd_math=sd(mathSS,na.rm=T),
            count_read=length(readSS),
            count_math=length(mathSS))
head(myag)
```

# More plyr
- This is great, we can quickly build a summary dataset from individual records
- A few advanced tricks. How do we build counts and percentages into our dataset?
```{r plyr3}
myag<-ddply(df, .(dist,grade),summarize,
            mean_read=mean(readSS,na.rm=T),
            mean_math=mean(mathSS,na.rm=T),
            sd_read=sd(readSS,na.rm=T),
            sd_math=sd(mathSS,na.rm=T),
            count_read=length(readSS),
            count_math=length(mathSS),
            count_black=length(race[race=='B']),
            per_black=length(race[race=='B'])/length(readSS))
summary(myag[,7:10])            
```


# Sorting
- A key way to explore data in tabular form is to sort data
- Sorting data in R can be dangerous as you can reorder the vectors of a dataframe
- We use the `order` function to sort data

```{r sortwrong}
df.badsort<-order(df$readSS,df$mathSS)
head(df.badsort)
```
- Why is this wrong?
- What is R giving us?
- Rownames...

# Correct Example
- To fix it, we need to tell R to reorder the rownames in the order we want

```{r sortright}
df.sort<-df[ order(df$readSS,df$mathSS,df$attday),]
head(df[,c(3,23,29,30)])
head(df.sort[,c(3,23,29,30)])
```



# Exercises
1. Sort `df` on `measerr` and `mathss`. What are the highest 5 values of each. 

